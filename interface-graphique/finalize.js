#!/usr/bin/env node

/**
 * üéØ SCRIPT DE FINALISATION - La Machine √âthique
 * 
 * Ce script finalise le projet en :
 * 1. Compilant TypeScript
 * 2. V√©rifiant les d√©pendances
 * 3. Testant les composants
 * 4. Pr√©parant le d√©ploiement
 */

const { execSync, spawn } = require('child_process');
const fs = require('fs');
const path = require('path');

// Configuration
const CONFIG = {
    projectName: 'La Machine √âthique',
    version: '1.0.0',
    buildDir: 'dist',
    srcDir: 'src',
    components: [
        'FinchInterface',
        'ReeseInterface', 
        'EthicalMachineCore',
        'NumbersAlert',
        'ShawInterface',
        'RootInterface',
        'UnifiedInterface',
        'ThreatAssessment',
        'InterventionSystem'
    ]
};

/**
 * üé® Affichage color√© dans la console
 */
const colors = {
    reset: '\x1b[0m',
    bright: '\x1b[1m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    magenta: '\x1b[35m',
    cyan: '\x1b[36m'
};

function log(message, color = 'reset') {
    console.log(`${colors[color]}${message}${colors.reset}`);
}

function logStep(step, message) {
    log(`\n${step} ${message}`, 'cyan');
}

function logSuccess(message) {
    log(`‚úÖ ${message}`, 'green');
}

function logError(message) {
    log(`‚ùå ${message}`, 'red');
}

function logWarning(message) {
    log(`‚ö†Ô∏è  ${message}`, 'yellow');
}

/**
 * üîç V√©rification des pr√©requis
 */
function checkPrerequisites() {
    logStep('üîç', 'V√©rification des pr√©requis...');
    
    const requiredFiles = [
        'package.json',
        'tsconfig.json',
        'start.js',
        'index.html'
    ];
    
    const requiredDirs = [
        'src/components',
        'assets'
    ];
    
    // V√©rifier les fichiers requis
    for (const file of requiredFiles) {
        if (!fs.existsSync(file)) {
            logError(`Fichier manquant: ${file}`);
            return false;
        }
        logSuccess(`Fichier trouv√©: ${file}`);
    }
    
    // V√©rifier les r√©pertoires requis
    for (const dir of requiredDirs) {
        if (!fs.existsSync(dir)) {
            logWarning(`R√©pertoire manquant: ${dir}`);
            fs.mkdirSync(dir, { recursive: true });
            logSuccess(`R√©pertoire cr√©√©: ${dir}`);
        } else {
            logSuccess(`R√©pertoire trouv√©: ${dir}`);
        }
    }
    
    // V√©rifier Node.js et npm
    try {
        const nodeVersion = execSync('node --version', { encoding: 'utf8' }).trim();
        const npmVersion = execSync('npm --version', { encoding: 'utf8' }).trim();
        logSuccess(`Node.js: ${nodeVersion}`);
        logSuccess(`npm: ${npmVersion}`);
    } catch (error) {
        logError('Node.js ou npm non trouv√©');
        return false;
    }
    
    return true;
}

/**
 * üì¶ Installation des d√©pendances
 */
function installDependencies() {
    logStep('üì¶', 'Installation des d√©pendances...');
    
    try {
        log('Installation des d√©pendances npm...');
        execSync('npm install', { stdio: 'inherit' });
        logSuccess('D√©pendances install√©es');
        return true;
    } catch (error) {
        logError('Erreur lors de l\'installation des d√©pendances');
        return false;
    }
}

/**
 * üîß Compilation TypeScript
 */
function compileTypeScript() {
    logStep('üîß', 'Compilation TypeScript...');
    
    try {
        log('Compilation en cours...');
        execSync('npx tsc', { stdio: 'inherit' });
        
        // V√©rifier que les fichiers compil√©s existent
        const distDir = path.join(__dirname, CONFIG.buildDir);
        if (!fs.existsSync(distDir)) {
            logError('R√©pertoire dist non cr√©√©');
            return false;
        }
        
        // V√©rifier les composants compil√©s
        for (const component of CONFIG.components) {
            const jsFile = path.join(distDir, 'components', `${component}.js`);
            if (!fs.existsSync(jsFile)) {
                logWarning(`Composant non compil√©: ${component}`);
            } else {
                logSuccess(`Composant compil√©: ${component}`);
            }
        }
        
        logSuccess('Compilation TypeScript termin√©e');
        return true;
    } catch (error) {
        logError('Erreur lors de la compilation TypeScript');
        return false;
    }
}

/**
 * üß™ Tests des composants
 */
function testComponents() {
    logStep('üß™', 'Tests des composants...');
    
    try {
        // Test de chargement des composants compil√©s
        const distPath = path.join(__dirname, CONFIG.buildDir);
        
        for (const component of CONFIG.components) {
            try {
                const componentPath = path.join(distPath, 'components', component);
                require(componentPath);
                logSuccess(`Composant test√©: ${component}`);
            } catch (error) {
                logWarning(`Erreur de test pour ${component}: ${error.message}`);
            }
        }
        
        // Test du script de d√©marrage
        log('Test du script de d√©marrage...');
        const startScript = require('./start.js');
        if (typeof startScript.main === 'function') {
            logSuccess('Script de d√©marrage valide');
        } else {
            logWarning('Script de d√©marrage invalide');
        }
        
        return true;
    } catch (error) {
        logError('Erreur lors des tests');
        return false;
    }
}

/**
 * üìã V√©rification de l'interface utilisateur
 */
function checkUserInterface() {
    logStep('üìã', 'V√©rification de l\'interface utilisateur...');
    
    const uiFiles = [
        'index.html',
        'renderer/css/style.css',
        'renderer/js/renderer.js'
    ];
    
    for (const file of uiFiles) {
        if (fs.existsSync(file)) {
            const stats = fs.statSync(file);
            logSuccess(`${file} (${Math.round(stats.size / 1024)}KB)`);
        } else {
            logWarning(`Fichier UI manquant: ${file}`);
        }
    }
    
    return true;
}

/**
 * üöÄ Pr√©paration du d√©ploiement
 */
function prepareDeployment() {
    logStep('üöÄ', 'Pr√©paration du d√©ploiement...');
    
    try {
        // Cr√©er le r√©pertoire de d√©ploiement
        const deployDir = path.join(__dirname, 'deploy');
        if (!fs.existsSync(deployDir)) {
            fs.mkdirSync(deployDir, { recursive: true });
        }
        
        // Copier les fichiers n√©cessaires
        const filesToCopy = [
            'start.js',
            'package.json',
            'index.html',
            'preload.js'
        ];
        
        for (const file of filesToCopy) {
            if (fs.existsSync(file)) {
                fs.copyFileSync(file, path.join(deployDir, file));
                logSuccess(`Copi√©: ${file}`);
            }
        }
        
        // Copier le r√©pertoire dist
        const distDir = path.join(__dirname, CONFIG.buildDir);
        if (fs.existsSync(distDir)) {
            const deployDistDir = path.join(deployDir, CONFIG.buildDir);
            if (!fs.existsSync(deployDistDir)) {
                fs.mkdirSync(deployDistDir, { recursive: true });
            }
            
            // Copier r√©cursivement
            function copyRecursive(src, dest) {
                const items = fs.readdirSync(src);
                for (const item of items) {
                    const srcPath = path.join(src, item);
                    const destPath = path.join(dest, item);
                    
                    if (fs.statSync(srcPath).isDirectory()) {
                        if (!fs.existsSync(destPath)) {
                            fs.mkdirSync(destPath, { recursive: true });
                        }
                        copyRecursive(srcPath, destPath);
                    } else {
                        fs.copyFileSync(srcPath, destPath);
                    }
                }
            }
            
            copyRecursive(distDir, deployDistDir);
            logSuccess('R√©pertoire dist copi√©');
        }
        
        // Cr√©er un script de lancement
        const launcherScript = `#!/usr/bin/env node
console.log('üöÄ Lancement de ${CONFIG.projectName} v${CONFIG.version}...');
require('./start.js');
`;
        
        fs.writeFileSync(path.join(deployDir, 'launch.js'), launcherScript);
        logSuccess('Script de lancement cr√©√©');
        
        // Cr√©er un README de d√©ploiement
        const deployReadme = `# ${CONFIG.projectName} v${CONFIG.version}

## üöÄ D√©ploiement

### Pr√©requis
- Node.js 16+ 
- npm

### Installation
\`\`\`bash
npm install
\`\`\`

### Lancement
\`\`\`bash
node launch.js
\`\`\`

### Ou avec npm
\`\`\`bash
npm start
\`\`\`

## üìã Composants

- ü§ñ EthicalMachineCore - C≈ìur de la machine
- üë®‚Äçüíº FinchInterface - Configuration √©thique
- üïµÔ∏è ReeseInterface - Surveillance op√©rationnelle
- üì¢ NumbersAlert - Notifications
- üîç ShawInterface - Analyse forensique
- üîê RootInterface - Acc√®s syst√®me
- üîó UnifiedInterface - Coordination

## üõ°Ô∏è Fonctionnalit√©s

- D√©tection de menaces √©thique
- Surveillance en temps r√©el
- Analyse forensique
- Notifications intelligentes
- Contr√¥le d'acc√®s s√©curis√©
- Interface unifi√©e

---
*Inspir√© de Person of Interest*
`;
        
        fs.writeFileSync(path.join(deployDir, 'README.md'), deployReadme);
        logSuccess('README de d√©ploiement cr√©√©');
        
        return true;
    } catch (error) {
        logError(`Erreur lors de la pr√©paration: ${error.message}`);
        return false;
    }
}

/**
 * üìä Rapport de finalisation
 */
function generateReport(success, steps) {
    logStep('üìä', 'Rapport de finalisation...');
    
    const report = {
        project: CONFIG.projectName,
        version: CONFIG.version,
        timestamp: new Date().toISOString(),
        success: success,
        steps: steps
    };
    
    // Sauvegarder le rapport
    fs.writeFileSync('finalization-report.json', JSON.stringify(report, null, 2));
    logSuccess('Rapport sauvegard√©: finalization-report.json');
    
    // Afficher le r√©sum√©
    log('\nüìã R√âSUM√â DE LA FINALISATION', 'bright');
    log(`Projet: ${CONFIG.projectName} v${CONFIG.version}`, 'cyan');
    log(`Statut: ${success ? 'SUCC√àS' : '√âCHEC'}`, success ? 'green' : 'red');
    log(`Date: ${new Date().toLocaleString()}`, 'cyan');
    
    log('\n√âtapes:', 'bright');
    for (const [step, status] of Object.entries(steps)) {
        const icon = status ? '‚úÖ' : '‚ùå';
        const color = status ? 'green' : 'red';
        log(`${icon} ${step}`, color);
    }
    
    if (success) {
        log('\nüéâ PROJET FINALIS√â AVEC SUCC√àS !', 'bright');
        log('Vous pouvez maintenant lancer l\'application avec:', 'cyan');
        log('npm start', 'yellow');
        log('ou', 'cyan');
        log('node start.js', 'yellow');
    } else {
        log('\n‚ö†Ô∏è  FINALISATION INCOMPL√àTE', 'bright');
        log('V√©rifiez les erreurs ci-dessus et relancez le script', 'yellow');
    }
}

/**
 * üéØ Fonction principale
 */
async function main() {
    log('üéØ FINALISATION DE LA MACHINE √âTHIQUE', 'bright');
    log(`Version: ${CONFIG.version}`, 'cyan');
    log(`Date: ${new Date().toLocaleString()}`, 'cyan');
    
    const steps = {};
    let overallSuccess = true;
    
    // √âtape 1: V√©rification des pr√©requis
    steps['V√©rification des pr√©requis'] = checkPrerequisites();
    if (!steps['V√©rification des pr√©requis']) {
        overallSuccess = false;
        generateReport(overallSuccess, steps);
        process.exit(1);
    }
    
    // √âtape 2: Installation des d√©pendances
    steps['Installation des d√©pendances'] = installDependencies();
    if (!steps['Installation des d√©pendances']) {
        overallSuccess = false;
    }
    
    // √âtape 3: Compilation TypeScript
    steps['Compilation TypeScript'] = compileTypeScript();
    if (!steps['Compilation TypeScript']) {
        overallSuccess = false;
    }
    
    // √âtape 4: Tests des composants
    steps['Tests des composants'] = testComponents();
    if (!steps['Tests des composants']) {
        overallSuccess = false;
    }
    
    // √âtape 5: V√©rification de l'interface
    steps['V√©rification de l\'interface'] = checkUserInterface();
    if (!steps['V√©rification de l\'interface']) {
        overallSuccess = false;
    }
    
    // √âtape 6: Pr√©paration du d√©ploiement
    steps['Pr√©paration du d√©ploiement'] = prepareDeployment();
    if (!steps['Pr√©paration du d√©ploiement']) {
        overallSuccess = false;
    }
    
    // G√©n√©rer le rapport final
    generateReport(overallSuccess, steps);
    
    if (overallSuccess) {
        process.exit(0);
    } else {
        process.exit(1);
    }
}

// Lancer la finalisation
if (require.main === module) {
    main().catch(error => {
        logError(`Erreur fatale: ${error.message}`);
        process.exit(1);
    });
}

module.exports = { main, CONFIG }; 